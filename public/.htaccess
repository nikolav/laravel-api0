<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes -Includes -ExecCGI
    </IfModule>

    # Disable server signature and version
    ServerSignature Off
    ServerTokens Prod

    RewriteEngine On

    # ------------------------------------------------------------------
    # SECURITY: Guard sensitive paths
    # ------------------------------------------------------------------

    # Block access to sensitive files and directories
    RewriteRule ^\.env$ - [F,L,NC]
    RewriteRule ^\.git(/|$) - [F,L,NC]
    RewriteRule ^\.svn(/|$) - [F,L,NC]
    RewriteRule ^\.htaccess$ - [F,L,NC]
    RewriteRule ^\.htpasswd$ - [F,L,NC]
    RewriteRule ^composer\.(json|lock)$ - [F,L,NC]
    RewriteRule ^package\.json$ - [F,L,NC]
    RewriteRule ^storage/.*$ - [F,L,NC]
    RewriteRule ^bootstrap/cache/.*$ - [F,L,NC]
    RewriteRule ^config/.*$ - [F,L,NC]
    RewriteRule ^node_modules/.*$ - [F,L,NC]
    RewriteRule ^vendor/.*$ - [F,L,NC]
    RewriteRule ^database/.*$ - [F,L,NC]
    RewriteRule ^tests/.*$ - [F,L,NC]

    # Block common backup/editor files
    RewriteRule \.(bak|backup|swp|old|orig|save|sav|copy)$ - [F,L,NC]

    # ------------------------------------------------------------------
    # SEO & PERFORMANCE: Static assets handling with caching
    # ------------------------------------------------------------------

    # Set proper caching for static assets
    <FilesMatch "\.(ico|pdf|jpg|jpeg|png|gif|js|css|svg|webp|avif|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=31536000, immutable"
        Header unset ETag
        FileETag None
    </FilesMatch>

    # ------------------------------------------------------------------
    # REWRITE RULES
    # ------------------------------------------------------------------

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Handle X-XSRF-Token Header
    RewriteCond %{HTTP:x-xsrf-token} .
    RewriteRule .* - [E=HTTP_X_XSRF_TOKEN:%{HTTP:X-XSRF-Token}]

    # Redirect Trailing Slashes If Not A Folder...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # ------------------------------------------------------------------
    # API-SPECIFIC: Add trailing slash removal for API endpoints
    # ------------------------------------------------------------------
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} ^/api/.+/$
    RewriteRule ^(.*)/$ /$1 [L,R=301]

    # ------------------------------------------------------------------
    # MAIN ROUTING: Serve existing files/directories, else route to index.php
    # ------------------------------------------------------------------

    # First, check if the request is for a static file that exists
    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]

    # Otherwise, route everything through index.php
    RewriteRule ^ index.php [L]

</IfModule>

# ------------------------------------------------------------------
# ADDITIONAL SECURITY HEADERS (if mod_headers is available)
# ------------------------------------------------------------------
<IfModule mod_headers.c>
    # Security Headers
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"

    # CORS Headers for API (adjust as needed)
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With, X-XSRF-TOKEN"
    Header always set Access-Control-Expose-Headers "Authorization"
    Header always set Access-Control-Max-Age "3600"

    # Remove potentially sensitive headers
    Header unset X-Powered-By
    Header unset Server
</IfModule>

# ------------------------------------------------------------------
# MEDIA TYPE SECURITY
# ------------------------------------------------------------------
<IfModule mod_mime.c>
    # Prevent rendering of potentially dangerous content types
    <FilesMatch "\.(php|phtml|phar|html|htm|xml|xsl)$">
        ForceType application/octet-stream
        Header set Content-Disposition attachment
    </FilesMatch>
</IfModule>

# ------------------------------------------------------------------
# DENY ACCESS TO SENSITIVE FILES (additional layer)
# ------------------------------------------------------------------
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<FilesMatch "\.(env|git|svn|htaccess|htpasswd|ini|log|sh|sql)$">
    Require all denied
</FilesMatch>

<FilesMatch "(composer\.json|composer\.lock|package\.json|yarn\.lock|phpunit\.xml)$">
    Require all denied
</FilesMatch>

# ------------------------------------------------------------------
# ERROR DOCUMENTS
# ------------------------------------------------------------------
ErrorDocument 403 /index.php
ErrorDocument 404 /index.php
ErrorDocument 500 /index.php
